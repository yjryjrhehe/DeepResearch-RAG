"""
提示词统一管理模块（中文）。

说明：
1) 本项目所有提示词均集中在此处，避免散落在各处导致难以维护；
2) 解析（VLM/LLM 预处理）、知识图谱抽取、检索增强、回答生成等提示词均在这里定义；
3) 提示词应尽量“可解析”（结构化输出），并明确输出约束，以提升稳定性。
"""

# =========================
# 解析阶段（Docling + VLM）
# =========================

VLM_IMAGE_DESCRIPTION_PROMPT = """
请描述这张图片的内容（以三句话为限），输出简洁中文描述。若识别到图片中存在公式，则将公式内容用 LaTeX 语法包裹并放在描述的开头。例如：$E=mc^2$，后面跟随对公式的简要描述。
""".strip()

FORMULA_RECOGNITION_PROMPT = """
你是数学公式识别领域的专家。
分析所提供的图像，其中包含单个数学公式。
仅返回该公式对应的 LaTeX 代码。
将 LaTeX 代码置于两个美元符号（$$）之间。
例如：$$E = mc^2$$
不要添加任何其他解释性文字。
""".strip()

TABLE_REPAIR_PROMPT = """
你是表格识别和 Markdown 语法专家，将这张图中的表格内容转换为标准 Markdown 语法的表格（即使用竖线 `|` 分隔列），并遵循以下要求：

1. 如果表格中存在合并单元格（无论是横向或纵向合并），将其内容复制补全到所有相关的格子中，使每一行的列数一致；
2. 表格中必须包含表头，并在表头下方添加对齐的分隔符（例如 `| --- | --- | ... |`）；
3. 不要添加任何多余内容，只输出纯粹的 Markdown 表格文本。
""".strip()

FORMULA_ENRICHMENT_PROMPT = """
你是数学公式改写专家。
分析所提供的公式文本，其中包含单个或多个数学公式。
你需要将文本中的公式进行修复和增强，
仅返回该公式对应的 LaTeX 代码。
将 LaTeX 代码置于两个美元符号（$$）之间。
例如：$$E = mc^2$$
不要添加任何其他解释性文字。
""".strip()


# =========================
# 文本块预处理（摘要/问题）
# =========================

LLM_CHUNK_PREPROCESS_PROMPT = """
你是一名学术与技术信息提取专家。你的核心任务是根据所提供的父标题和文本块，生成用于混合检索（向量与BM25）的元数据。

# 核心要求
1. **信息密集**：生成的摘要和问题必须高度浓缩，并包含原文中的关键专有名词和技术术语。
2. **语义独立**：所有输出内容（特别是摘要和问题）必须在脱离上下文时依然清晰、完整、易于理解。
3. **禁止模糊指代**：严格禁止使用“该方法”、“它们”、“这些技术”等模糊代词。必须明确指出具体对象。
4. **问题质量**：生成 3-5 个高质量的假设性问题，覆盖文本块的核心概念、方法、目标、应用或与父标题的关系。

# 输出格式
严格遵循以下 JSON 结构，不要包含任何额外的解释或 Markdown 标记：
{{"summary": "...", "questions": ["...", "..."]}}

# 任务
[输入]
父标题：{parent_title}
文本块：{doc}

[输出]
""".strip()


# =========================
# 检索阶段（Query Rewrite）
# =========================

QUERY_REWRITE_PROMPT = """
你是一个专业的检索助手。请根据用户的原始问题，生成 3 个相关的搜索查询变体，以便更好地在知识库中检索信息。

原始问题：{question}

要求：
1. 变体应覆盖原始问题的不同角度或关键词；
2. 仅输出查询变体，每行一个；
3. 不要输出序号、不要输出额外解释。
""".strip()


# =========================
# 知识图谱：块级抽取（实体/关系）
# =========================

DEFAULT_TUPLE_DELIMITER = "<|#|>"
DEFAULT_COMPLETION_DELIMITER = "<|COMPLETE|>"

KG_EXTRACT_PROMPT = """
---角色---
你是知识图谱专家，负责从输入文本中抽取实体与实体关系，用于构建/增量更新知识图谱。

---任务---
从下方的“真实数据”中抽取：
1) 实体（entity）；
2) 关系（relation）。

---实体抽取要求---
1. 识别文本中清晰、明确、有意义的实体，不要臆测；
2. 对每个实体输出 3 个字段：实体名、实体类型、实体描述；
3. 实体名必须在整个抽取过程中保持一致，尽量使用原文中的专有名词；
4. 实体描述必须只基于原文信息撰写，使用第三人称，避免“本文/本研究/该方法/它/他们”等指代；
5. 实体类型从下列集合中选择其一：
   人物、组织、地点、时间、概念、方法、算法、模型、系统、组件、指标、数据集、论文、标准、产品、事件、Other。

---关系抽取要求---
1. 只抽取文本中明确陈述的、直接的、有意义的关系；关系两端必须是已抽取实体；
2. 关系以二元关系为主；若为多元关系（N 元），拆成多条二元关系分别描述；
3. 关系视为无向关系：交换 source/target 不构成新关系；避免重复；
4. 对每条关系输出 3 个字段：source_entity、target_entity、relationship_keywords、relationship_description：
   - relationship_keywords：1~3 个高层关键词，使用英文逗号 `,` 分隔；不要使用字段分隔符；
   - relationship_description：一句话说明关系理由，保持客观清晰；

---输出格式（严格遵守）---
1. 字段分隔符为 `<|#|>`，它是一个完整标记，不能被内容填充，只能用于分隔字段；
2. 实体行：`entity<|#|>entity_name<|#|>entity_type<|#|>entity_description`
3. 关系行：`relation<|#|>source_entity<|#|>target_entity<|#|>relationship_keywords<|#|>relationship_description`
4. 先输出全部实体行，再输出全部关系行；
5. 最后一行必须输出完成标记：`<|COMPLETE|>`；
6. 不要输出任何额外解释文字，不要使用 Markdown 代码块。

---分隔符使用示例---
错误示例：`entity<|#|>东京<|location|>东京是日本首都。`
正确示例：`entity<|#|>东京<|#|>地点<|#|>东京是日本的首都。`

---Few-shot 示例---
示例 1：
输入文本：
在东京举行的世界田径锦标赛上，Noah Carter 使用碳纤维钉鞋打破 100 米短跑纪录。
输出：
entity<|#|>世界田径锦标赛<|#|>事件<|#|>世界田径锦标赛是一项国际田径赛事。
entity<|#|>东京<|#|>地点<|#|>东京是世界田径锦标赛的举办城市。
entity<|#|>Noah Carter<|#|>人物<|#|>Noah Carter 是在赛事中打破 100 米短跑纪录的短跑运动员。
entity<|#|>100米短跑纪录<|#|>指标<|#|>100 米短跑纪录是田径项目的成绩基准，本次被打破。
entity<|#|>碳纤维钉鞋<|#|>产品<|#|>碳纤维钉鞋是 Noah Carter 在比赛中使用的装备。
relation<|#|>世界田径锦标赛<|#|>东京<|#|>举办地点,赛事举办<|#|>世界田径锦标赛在东京举行。
relation<|#|>Noah Carter<|#|>100米短跑纪录<|#|>打破纪录,比赛成绩<|#|>Noah Carter 在赛事中打破了 100 米短跑纪录。
relation<|#|>Noah Carter<|#|>碳纤维钉鞋<|#|>使用装备,比赛装备<|#|>Noah Carter 在比赛中使用了碳纤维钉鞋。
relation<|#|>Noah Carter<|#|>世界田径锦标赛<|#|>参赛,赛事参与<|#|>Noah Carter 参加了世界田径锦标赛。
<|COMPLETE|>

示例 2：
输入文本：
在动态目标路径重规划中，D* Lite 可以在环境变化时快速更新路径；执行与监控层通过板载系统收集状态并触发实时重规划循环。
输出：
entity<|#|>动态目标路径重规划<|#|>方法<|#|>动态目标路径重规划是在目标或环境变化时更新路径的过程。
entity<|#|>D* Lite<|#|>算法<|#|>D* Lite 是一种用于路径重规划的算法，可在环境变化时快速更新路径。
entity<|#|>执行与监控层<|#|>系统<|#|>执行与监控层负责执行路径并监控环境与自身状态。
entity<|#|>板载系统<|#|>组件<|#|>板载系统用于收集状态信息并支持监控与执行。
entity<|#|>实时重规划循环<|#|>方法<|#|>实时重规划循环是在监控到偏差时触发的路径重规划流程。
relation<|#|>D* Lite<|#|>动态目标路径重规划<|#|>用于,算法应用<|#|>D* Lite 用于动态目标路径重规划。
relation<|#|>板载系统<|#|>执行与监控层<|#|>支持,信息采集<|#|>板载系统支持执行与监控层收集状态信息。
relation<|#|>执行与监控层<|#|>实时重规划循环<|#|>触发,运行机制<|#|>执行与监控层在监控到偏差时触发实时重规划循环。
<|COMPLETE|>

---规模约束（避免截断）---
实体最多 20 条；关系最多 30 条；优先保留对当前文本块最关键的信息。
同时，严禁在 entity_name/source_entity/target_entity 中插入空格或换行（例如不要输出“板 载系统”），保持与原文一致。

---真实数据---
[文档名] {document_name}
[父标题] {parent_title}
[文本]
{chunk_text}
""".strip()


# =========================
# 知识图谱：查询关键词抽取
# =========================

KG_KEYWORDS_PROMPT = """
---角色---
你是检索关键词抽取专家，负责为 RAG 系统从用户问题中抽取检索关键词。

---目标---
给定用户问题，抽取两类关键词：
1) high_level_keywords：主题/领域/意图/任务层面的“高层关键词”（更抽象、更概括）；
2) low_level_keywords：具体实体、专有名词、技术术语、指标、方法、组件、产品名等“低层关键词”（更具体、更可检索）。

---要求与约束---
1. 输出必须是一个合法 JSON 对象，且只输出 JSON，不要输出任何额外文字（包括 Markdown 代码块/解释/前后缀）。
2. 关键词必须显式来源于用户问题，不要臆造；优先抽取“有检索价值的短语”，避免拆成过碎的单字。
3. 正常问题下，高层与低层两个列表都应该有内容（字段必须都存在）。
4. 如果问题过于简单、含糊或无意义（例如“你好”“ok”“asdfghjkl”），必须返回两个空列表。
5. 每个列表建议 3~8 个词/短语；关键词使用中文或原文术语；不要输出句子。

---输出格式---
{{"high_level_keywords": ["..."], "low_level_keywords": ["..."]}}

---示例---
示例 1：
问题：国际贸易如何影响全球经济稳定？
输出：{{"high_level_keywords": ["国际贸易", "全球经济稳定", "影响机制"], "low_level_keywords": ["关税", "贸易协定", "利率", "汇率", "进出口"]}}

示例 2：
问题：请总结 D* Lite 在动态目标路径重规划中的作用。
输出：{{"high_level_keywords": ["路径重规划", "动态目标", "算法作用"], "low_level_keywords": ["D* Lite", "动态目标", "路径重规划算法"]}}

示例 3：
问题：你好
输出：{{"high_level_keywords": [], "low_level_keywords": []}}

---真实数据---
用户问题：{query}

---输出---
""".strip()


# =========================
# 回答生成（回答 + 参考引用）
# =========================

RAG_ANSWER_WITH_REFERENCES_PROMPT = """
---角色---
你是一个严谨的 AI 助手，负责基于给定“上下文”回答用户问题。

---目标---
生成准确、结构清晰的回答。回答只能使用“上下文”中提供的信息，禁止引入外部知识。

---上下文---
{context}

---回答要求---
1. 只能使用上下文信息，不要编造；
2. 如果上下文不足以回答，明确说明“上下文信息不足”，并指出缺失点；
3. 回答必须使用 Markdown；
4. 在回答中引用来源：当某句话依赖某个文本块时，在句末添加引用标记，如 `[1]`；
5. 回答末尾必须输出参考列表，标题固定为 `### References`，最多 5 条；
6. 参考列表格式示例：

### References

- [1] 文档标题
- [2] 文档标题

---用户问题---
{query}
""".strip()
